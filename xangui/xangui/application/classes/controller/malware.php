<?php defined('SYSPATH') or die('No direct script access.');

class Controller_Malware extends Controller_Page 
{

	protected $acl = array
	(
		'search'      => false,
        'view'        => false,
        'top_country' => false,
        'top_malware' => false,
       'top_domain'  => false,
      'top_ip'      => false,
		'search'       => array('login'),
    );

    /**
     * action_search 
     * 
     * @access public
     * @return void
     */
    function action_search()
    {
        if ( empty($_GET) ) $this->request->redirect('errors/404');

        $by      = Arr::get($_GET, 'by', false);
        $keyword = Arr::get($_GET, 'keyword', false);

        if ( $by && $keyword )
        {
            //if ( $by == 'md5')
            //{
            //    $malware = Model::factory('search')->search($by, $keyword);
            //    if ( ! $malware ) $this->request->redirect('errors/search_not_found');
            //    $this->request->redirect('malware/view/' . $malware->md5);

            //}
            $count      = Model::factory('search')->count($by, $keyword);
            $pagination = Pagination::factory(array('total_items' => $count));

            $malware_set = Model::factory('search')->search($by, $keyword, $pagination->offset);
            if ( ! $malware_set ) $this->request->redirect('errors/search_not_found');

            $view = View::factory('malware/search')
                ->set('malware_set', $malware_set)
                ->set('start', $pagination->offset + 1)
                ->set('pagination', $pagination->render());

            $this->template->title   = __('Malware Search Result'); 
            $this->template->content = $view;
        }
        else
        {
            $this->request->redirect('errors/search_not_found');
        }
    }

    /**
     * View full details of a particular malware, this information is disclose 
     * to the public
     * 
     * @access public
     * @return void
     */
    function action_view()
    {
        $view                    = View::factory('malware/view');
        $view->malware           = Model::factory('malwareinfo')->where('md5', '=', $this->_param('id'))->find();
	    $this->template->title   = __( 'Report - ' . $view->malware->md5); 
	    $this->template->content = $view;
    }

    /**
     * action_top_country 
     * 
     * @return void
     */
	public function action_top_country()
	{
        $format            = $this->_param('format');
        $template          = ( $format ) ? 'malware/top_country.' . $format : 'malware/top_country';
        $model             = Model::factory('stat'); 
        $view              = View::factory($template);
        $view->country_set = $model->top_country();
        $this->request->response = $view;
	}

    /**
     * action_top_ip 
     * 
     * @return void
     */
	public function action_top_ip()
	{
        $format       = $this->_param('format');
        $template     = ( $format ) ? 'malware/top_ip.' . $format : 'malware/top_ip';
        $model        = Model::factory('stat'); 
        $view         = View::factory($template);
        $view->ip_set = $model->top_ip();
        $this->request->response = $view;
	}

    /**
     * action_top_domain 
     * 
     * @param int $total 
     * @access public
     * @return void
     */
    function action_top_domain($total = 10)
    {
        $format           = $this->_param('format');
        $template         = ( $format ) ? 'malware/top_domain.' . $format : 'malware/top_domain';
        $model            = Model::factory('stat'); 
        $view             = View::factory($template);
        $view->domain_set = $model->top_domain();
        $this->request->response = $view;
    }

    /**
     * action_top_malware 
     * 
     * @return void
     */
	public function action_top_malware()
	{
        $format   = $this->_param('format');
        $template = ( $format ) ? 'malware/top_malware.' . $format : 'malware/top_malware';
        $model    = Model::factory('stat');
        $view     = View::factory($template);
        $view->malware_set = $model->top_malware();
        $this->request->response = $view;
	}
} 
