<div style="font-weight: bold; font-size: 16pt;"class="grid_6">
    <?php echo $malware->name(); ?>
</div>

<div class="grid_6">
    <div style="text-align:right;">
		<?php
		        if ( Auth::instance()->get_user() )
		                {
								$user = Auth::instance()->get_user();
		        
		                		if ( $user->has_role('admin') || $user->has_role('researchers') || $user->has_role('community') )
		                        {
		                                echo Html::css_button('/file/download/' . $malware->sha512, 'Download File');
		                        }
		                }
		?>
    </div>
</div>

<div class="grid_6">
	<div class="grid_6">
	        <!-- AddThis Button BEGIN -->
	        <div class="addthis_toolbox addthis_default_style ">
	        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	        <a class="addthis_button_tweet"></a>
	        <a class="addthis_counter addthis_pill_style"></a>
	        </div>
	        <script type="text/javascript">var addthis_config = {"data_track_clickback":true};</script>
	        <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4d8034602632603f"></script>
	        <!-- AddThis Button END -->
	</div>

</div>



<div class="grid_12">
    <div style="text-align:left;">
    </div>
</div>

<div class="grid_12">
<div class="section">File Details</div>
<table style="margin: 1em;" width="100%">

<?php
    // non-register member can only see 5 items
	$login = ( Auth::instance()->get_user() ) ? false : true;

    //if ( Auth::instance()->get_user() )
    //{
	$limit = ( Auth::instance()->get_user() ) ? false : 5;
	
    //}
    //else
    //{
     //   $limit = 5;
    //}


//    $col = array(  
//        'MD5'                => $malware->md5,
//		'SHA-1'				 => $malware->sha1,
//        'First Received'	 => $malware->cdate . " " . $malware->ctime,
//        'Last Received'		 => $malware->mdate . " " . $malware->mtime,
//        'Size (bytes)' 	     => $malware->filesize,
//		'Weightage'          => $malware->score,
//        'virustotal.com'     => $malware->scaninfo->count_all() . ' vendors detected',
//    );

//    foreach (  $col as $name => $value )
//    {
//        echo "<tr>";
//        echo "<td width='15%'>$name</td>";
//       echo "<td class='wordwrap'>" . $value . "</td>";
//        echo "</tr>";
//    }

	//$mal_set = ( $limit > 0 ) 
	//        ? $malware->malwareinfo->limit($limit)->find_all()
	//       : $malware->malwareinfo->find_all();



	    if ( $malware->status == "Queue" )
	    {	
			echo "<fieldset>";
			echo "<label>Current status: <b>queued</b></label>";
			echo "</fieldset>";
		}
		else if ( $malware->status == "Ready" )
	    {	
			echo "<fieldset>";
			echo "<label>Current status: <b>analyzing</b></label>";
			echo "</fieldset>";
		}	
		else if ( ! $malware->status )
		{	
			echo "<fieldset>";
			echo "<label><b>Not found:</b> The item you searched for was not found in Xandora's database </label>";
			echo "</fieldset>";
		}
		
		else {
    		$col = array(  
        		'MD5'                => $malware->md5,
				'SHA-1'				 => $malware->sha1,
        		'First Received (GMT+8)'	 => $malware->cdate . " " . $malware->ctime,
        		'Last Received (GMT+8)'		 => $malware->mdate . " " . $malware->mtime,
        		'Size (bytes)' 		 => $malware->filesize,
				'Weightage'          => $malware->score,
        		'virustotal.com'     => $malware->scaninfo->count_all() . ' vendors detected',
    			);

    		foreach (  $col as $name => $value )
    		{
        		echo "<tr>";
        		echo "<td width='15%'>$name</td>";
        		echo "<td class='wordwrap'>" . $value . "</td>";
        		echo "</tr>";
    		}
		}

?>
</table>

<?php
   if ( $malware->staticheader->header )
	{
    	echo HTML::section('Static File Header', $login);
		echo nl2br($malware->staticheader->header);
	}
?>



<?php
if ( $malware->staticheader->peid )
	{
    	echo HTML::section('PEID', $login);
		echo nl2br($malware->staticheader->peid);
	}
?>


<?php
    $scan_set = ( $limit > 0 ) 
        ? $malware->scaninfo->limit($limit)->find_all()
        : $malware->scaninfo->find_all();
    
	#$scan_set = vendorname()->vname;
    
    if ( $scan_set->count() )
    {
        echo HTML::section('virustotal.com Output', $login);
		echo "<fieldset>";
		echo "<label>" . $malware->scaninfo->count_all() . " vendors from virtustotal.com detected as malware</label>";
		echo "</fieldset>";
        echo "<ul class='wordwrap'>";
        foreach ( $scan_set as $scan )
        {
            echo "<li>$scan->name</li>";
        }
        echo "</ul>";
    }
?>

<?php
    $file_set = ( $limit > 0 ) 
        ? $malware->generatedfile->limit($limit)->find_all()
        : $malware->generatedfile->find_all();
        
    if ( $file_set->count() )
    {
        echo HTML::section('Filesystem Change', $login);
		echo "<fieldset>";
		echo "<label>The following file was changed in the system</label>";
		echo "</fieldset>";
		echo "<ul class='wordwrap'>";
        foreach ( $file_set as $file )
        {
            echo "<li>$file->filename</li>";
        }
        echo "</ul>";
    }
?>

<?php
    $registry_set = ( $limit > 0 ) 
        ? $malware->registryinfo->order_by('category')->limit($limit)->find_all()
        : $malware->registryinfo->order_by('category')->find_all();

    if ( $registry_set->count() )
    {
        echo HTML::section('Registry Change', $login);
		echo "<fieldset>";
		echo "<label>The following Registry Keys were changed</label>";
		echo "</fieldset>";
        echo "<ul class='wordwrap'>";
        foreach ( $registry_set as $registry )
        {
            echo "<li>$registry->registry_key</li>";
        }
        echo "</ul>";
    }
?>

<?php
    $process_set = ( $limit > 0 )
        ? $malware->processinfo->limit($limit)->find_all()
        : $malware->processinfo->find_all();

    if ( $process_set->count() )
    {
        echo HTML::section('Running Process', $login);
        echo "<ul class='wordwrap'>";
        foreach ( $process_set as $process )
        {
            echo "<li><b>$process->process_name</b>, pid: $process->pid </li>";
        }
        echo "</ul>";
    }
?>

<?php
    $traffic_set = ( $limit > 0 )
        ? $malware->trafficinfo->where('domain', '!=', '')->group_by('domain')->limit($limit)->find_all()
        : $malware->trafficinfo->where('domain', '!=', '')->group_by('domain')->find_all();

    if ( $traffic_set->count() )
    {
        echo HTML::section('Traffic - by DNS', $login);
		echo "<fieldset>";
		echo "<label>Produces outbound traffic, view by DNS</label>";
		echo "</fieldset>";
        echo "<ul class='wordwrap'>";
        foreach ( $traffic_set as $traffic )
        {
            echo "<li>$traffic->domain</li>";
        }
        echo "</ul>";
    }
?>

<?php
    $traffic_set = ( $limit > 0 )
        ? $malware->trafficinfo->where('ipv4', '!=', '')->group_by('ipv4')->limit($limit)->find_all()
        : $malware->trafficinfo->where('ipv4', '!=', '')->group_by('ipv4')->find_all();

    if ( $traffic_set->count() )
    {
        echo HTML::section('Traffic - by TCP/IP Connections', $login);
		echo "<fieldset>";
		echo "<label>Produces outbound traffic, view by host and port</label>";
		echo "</fieldset>";
        echo "<ul class='wordwrap'>";
        foreach ( $traffic_set as $traffic )
        {
            echo "<li>$traffic->ipv4 : $traffic->port</li>";
        }
        echo "</ul>";
    }
?>

<?php
    $traffic_set = ( $limit > 0 )
        ? $malware->trafficinfo->where('url', '!=', '')->group_by('url')->limit($limit)->find_all()
        : $malware->trafficinfo->where('url', '!=', '')->group_by('url')->find_all();

    if ( $traffic_set->count() )
    {
        echo HTML::section('Traffic - by URL', $login);
		echo "<fieldset>";
		echo "Produces outbound traffic, view by URL";
    	echo "</fieldset>";
        echo "<ul class='wordwrap'>";
        foreach ( $traffic_set as $traffic )
        {
            list($domain, $params) = explode('/', $traffic->url);
            echo "<li><b>$domain</b>/$params</li>";
        }
        echo "</ul>";
	}
?>

<div style="padding-left: 1em;">
<?php
    $screenshot_set = $malware->screenshot->find_all();
    if ( $screenshot_set->count() )
    {
        echo HTML::section('Screen Capture', $login);
		echo "<fieldset>";
		echo "<label>The new window was created</label>";
		echo "</fieldset>";
        $i = 1;
        foreach ( $screenshot_set as $screenshot )
        {
            $url = 'http://s3.amazonaws.com/xandora/screenshot/' . $screenshot->filename;
            echo HTML::image($url);
            $i++;
        }
    }
?>
</div>
